#!/bin/bash

# Extract the host 
HOST=${CI_PROJECT_URL}
[[ $HOST =~ ^https?://[^/]+ ]] && HOST="${BASH_REMATCH[0]}/api/v4/projects/"

TAG_NAME=v${PRODUCT_VERSION}${TAG_SUFFIX}
echo "Creating tag ${TAG_NAME}";

http_code=$(curl -X POST "${HOST}${CI_PROJECT_ID}/repository/tags?tag_name=${TAG_NAME}&ref=${CI_COMMIT_SHA}" \
        --header "PRIVATE-TOKEN:${GITLAB_PRIVATE_TOKEN}" \
        --insecure \
        --silent \
        --output /dev/null \
        --write-out "%{http_code}")

if [[ "$http_code" != "201" ]]; then
    echo "${http_code}: Failed to create tag ${TAG_NAME}"
    exit 1;
fi
